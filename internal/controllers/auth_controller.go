package controllers

import (
	"net/http"

	"github.com/labstack/echo"

	"pentest-report/internal/services"

)

type AuthController struct {
	AuthService *services.AuthService
}

func NewAuthController(authService *services.AuthService) *AuthController {
	return &AuthController{AuthService: authService}
}

// Login handles user authentication
func (controller *AuthController) Login(c echo.Context) error {
    // Tạo biến để chứa thông tin đăng nhập từ JSON
    type loginData struct {
        Username string `json:"username"`
        Password string `json:"password"`
    }

    // Giải nén dữ liệu JSON vào biến login
    login := new(loginData)
    if err := c.Bind(login); err != nil {
        return err
    }

    // Kiểm tra xác thực người dùng
    user, err := controller.AuthService.Login(login.Username, login.Password)
    if err != nil {
        return c.JSON(http.StatusUnauthorized, map[string]string{"message": "Invalid credentials"})
    }

    // Tạo access token JWT
    accessToken, err := controller.AuthService.GenerateAccessToken(user.Username, user.Role)
    if err != nil {
        return err
    }

    // Trả về access token JWT
    return c.JSON(http.StatusOK, map[string]string{"access_token": accessToken})
}